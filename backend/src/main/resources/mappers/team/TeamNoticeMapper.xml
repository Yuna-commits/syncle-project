<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nullpointer.domain.team.mapper.TeamNoticeMapper">

    <!-- 공지사항 등록 -->
    <insert id="insertNotice" useGeneratedKeys="true" keyProperty="id">
        INSERT
        INTO team_notice (team_id,
                          writer_id,
                          title,
                          content,
                          is_important)
        VALUES (#{teamId},
                #{writerId},
                #{title},
                #{content},
                #{isImportant})
    </insert>

    <!-- 목록 조회 -->
    <select id="findAllByTeamId" resultType="TeamNoticeResponse">
        SELECT n.id,
               n.title,
               n.content,
               n.is_important,
               n.view_count,
               n.created_at,
               n.updated_at,
               u.id          AS writerId,
               u.nickname    AS writerNickname,
               u.profile_img AS writerProfileImg
        FROM team_notice n
                 JOIN user u ON n.writer_id = u.id
        WHERE n.team_id = #{teamId}
          AND n.deleted_at IS NULL
        ORDER BY n.is_important DESC, n.created_at DESC
    </select>

    <!-- 상세 조회 -->
    <select id="findById" resultType="TeamNoticeVo">
        SELECT *
        FROM team_notice
        WHERE id = #{noticeId}
          AND deleted_at IS NULL
    </select>

    <!-- 공지사항 수정 -->
    <update id="updateNotice">
        UPDATE team_notice
        <set>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="content != null">
                content = #{content},
            </if>
            <if test="isImportant != null">
                is_important = #{isImportant},
            </if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 공지사항 삭제 (Soft delete) -->
    <update id="deleteNotice">
        UPDATE team_notice
        SET deleted_at = NOW()
        WHERE id = #{noticeId}
          AND deleted_at IS NULL
    </update>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount">
        UPDATE team_notice
        SET view_count = view_count + 1
        WHERE id = #{noticeId}
          AND deleted_at IS NULL
    </update>

</mapper>