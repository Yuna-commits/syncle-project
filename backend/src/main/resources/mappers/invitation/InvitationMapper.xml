<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nullpointer.domain.invitation.mapper.InvitationMapper">

    <!-- 초대 생성 -->
    <insert id="insertInvitation" parameterType="InvitationVo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO invitation (team_id, inviter_id, invitee_id, token, status, expired_at, created_at)
        VALUES (#{teamId}, #{inviterId}, #{inviteeId}, #{token}, #{status}, #{expiredAt}, NOW())
    </insert>

    <!-- 토큰으로 초대장 조회 -->
    <select id="findByToken" parameterType="string" resultType="InvitationVo">
        SELECT *
        FROM invitation
        WHERE token = #{token}
    </select>

    <!-- ID로 초대장 조회 -->
    <select id="findById" parameterType="long" resultType="InvitationVo">
        SELECT *
        FROM invitation
        WHERE id = #{id}
          AND status != 'ACCEPTED'
    </select>

    <!-- 상태 변경 -->
    <update id="updateStatus" parameterType="InvitationVo">
        UPDATE invitation
        SET status       = #{status},
            responded_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 중복 초대 방지 -->
    <select id="existsByTeamIdAndInviteeIdAndStatus" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM invitation
                      WHERE team_id = #{teamId}
                        AND invitee_id = #{inviteeId}
                        AND status = #{status})
    </select>

    <!-- 팀원 초대 목록 -->
    <select id="findAllByTeamId" parameterType="long"
            resultType="com.nullpointer.domain.invitation.dto.TeamInvitationResponse">
        SELECT i.id,
               i.team_id,
               i.invitee_id,
               i.status,
               i.created_at,
               i.responded_at,
               u.email       AS inviteeEmail,
               u.nickname    AS inviteeName,
               u.profile_img AS inviteeProfile_img
        FROM invitation i
                 JOIN user u ON i.invitee_id = u.id
        WHERE i.team_id = #{teamId}
          AND i.status != 'ACCEPTED'
        ORDER BY i.created_at DESC
    </select>

    <!-- 내 초대 목록 -->
    <select id="findAllByUserId" parameterType="long"
            resultType="com.nullpointer.domain.invitation.dto.MyInvitationResponse">
        SELECT i.id,
               i.team_id,
               i.inviter_id,
               i.status,
               i.created_at,
               t.name        AS teamName,
               u.email       AS inviterEmail,
               u.nickname    AS inviterName,
               u.profile_img AS inviterProfile_img
        FROM invitation i
                 JOIN team t ON i.team_id = t.id
                 JOIN user u ON i.inviter_id = u.id
        WHERE i.invitee_id = #{userId}
          AND i.status = 'PENDING'
        ORDER BY i.created_at DESC
    </select>

    <!-- 초대 취소 -->
    <delete id="deleteInvitation" parameterType="long">
        DELETE
        FROM invitation
        WHERE id = #{invitationId}
    </delete>

    <!-- 만료 기간이 지난 대기 상태 초대장들을 'EXPIRED'로 일괄 업데이트 -->
    <update id="updateExpiredInvitations">
        UPDATE invitation
        SET status = 'EXPIRED'
        WHERE status = 'PENDING'
          AND expired_at &lt; NOW();
    </update>
</mapper>
