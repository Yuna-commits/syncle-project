<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nullpointer.domain.user.mapper.UserMapper">

    <!-- 회원가입 -->
    <insert id="insertUser" parameterType="UserVo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user (email,
                          password,
                          nickname,
                          description,
                          position,
                          profile_img,
                          provider,
                          provider_id,
                          verify_status,
                          user_status,
                          created_at,
                          updated_at)
        VALUES (#{email},
                #{password},
                #{nickname},
                #{description},
                #{position},
                #{profileImg},
                #{provider},
                #{providerId},
                #{verifyStatus},
                #{userStatus},
                NOW(),
                NOW())
    </insert>

    <!-- 이메일 중복 확인 -->
    <select id="existsByEmail" parameterType="string" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM user
                      WHERE email = #{email}
                        AND deleted_at IS NULL
                        AND verify_status = 'VERIFIED'
                        AND user_status = 'ACTIVATED')
    </select>

    <!-- 닉네임 중복 확인 -->
    <select id="existsByNickname" parameterType="string" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM user
                      WHERE nickname = #{nickname}
                        AND deleted_at IS NULL
                        AND verify_status = 'VERIFIED'
                        AND user_status = 'ACTIVATED')
    </select>

    <!-- 사용자 조회 -->
    <select id="findById" parameterType="long" resultType="UserVo">
        SELECT *
        FROM user
        WHERE id = #{id}
          AND deleted_at IS NULL
    </select>

    <!-- 여러 명의 사용자들 조회 - Param List -->
    <select id="findAllByIds" resultType="UserVo">
        SELECT *
        FROM user
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted_at IS NULL
    </select>

    <select id="findByEmail" parameterType="string" resultType="UserVo">
        SELECT *
        FROM user
        WHERE email = #{email}
          AND deleted_at IS NULL
    </select>

    <select id="findByNickname" parameterType="string" resultType="UserVo">
        SELECT *
        FROM user
        WHERE nickname = #{nickname}
          AND deleted_at IS NULL
    </select>

    <!-- 사용자 이메일 인증 상태 조건부 업데이트 -->
    <update id="updateVerifyStatusIfCurrent">
        UPDATE user
        SET verify_status = #{newStatus},
            updated_at    = NOW()
        WHERE id = #{id}
          AND verify_status = #{currentStatus}
          AND deleted_at IS NULL
    </update>

    <!-- 사용자 정보 조회 -->
    <select id="getUserProfile" resultType="com.nullpointer.domain.user.dto.response.UserProfileResponse">
        SELECT u.id,
               u.email,
               u.nickname,
               u.description,
               u.position,
               u.profile_img,
               u.verify_status,
               u.provider,
               u.created_at,
               u.updated_at,
               (SELECT COUNT(*)
                FROM team_member tm
                         JOIN team t ON t.id = tm.team_id
                WHERE tm.user_id = u.id
                  AND tm.deleted_at IS NULL
                  AND t.deleted_at IS NULL)  AS "activity.participatedTeams",
               (SELECT COUNT(*)
                FROM board_member bm
                         JOIN board b ON b.id = bm.board_id
                WHERE bm.user_id = u.id
                  AND bm.deleted_at IS NULL
                  AND b.deleted_at IS NULL)  AS "activity.participatedBoards",
               (SELECT COUNT(*)
                FROM card cd
                WHERE cd.assignee_id = u.id) AS "activity.createdCards",
               (SELECT COUNT(*)
                FROM comment c
                WHERE c.writer_id = u.id
                  AND c.deleted_at IS NULL)  AS "activity.createdComments",
               (SELECT COUNT(*)
                FROM activity_log al
                WHERE al.user_id = u.id)     AS "activity.activityLogs"
        -- 안 읽은 알림 개수 쿼리 추가 필요
        FROM user u
        WHERE u.id = #{id}
          AND u.deleted_at IS NULL
    </select>

    <!-- 사용자 정보 수정 -->
    <update id="updateUser">
        UPDATE user
        <set>
            <if test="nickname != null">nickname = #{nickname},</if>
            <if test="description != null">description = #{description},</if>
            <if test="position != null">position = #{position},</if>
            <if test="profileImg != null">profile_img = #{profileImg},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
        AND deleted_at IS NULL
    </update>

    <!-- 사용자 비밀번호 수정 -->
    <update id="updatePassword">
        UPDATE user
        SET password   = #{newPassword},
            updated_at = NOW()
        WHERE id = #{id}
          AND deleted_at IS NULL
    </update>

    <!-- 사용자 요약 정보 조회 -->
    <select id="getUserSummary" resultType="com.nullpointer.domain.user.dto.response.UserSummaryResponse">
        SELECT id,
               email,
               nickname,
               position,
               profile_img
        FROM user
        WHERE id = #{userId}
          AND deleted_at IS NULL
    </select>

    <!-- 멤버 추가 시 사용자 검색 -->
    <select id="searchUsers" parameterType="string"
            resultType="com.nullpointer.domain.user.dto.response.UserSummaryResponse">
        SELECT id,
               email,
               nickname,
               position,
               profile_img
        FROM user
        WHERE (email LIKE CONCAT('%', #{keyword}, '%') OR nickname LIKE CONCAT('%', #{keyword}, '%'))
          AND user_status = 'ACTIVATED'
          AND deleted_at IS NULL LIMIT 10
    </select>

    <!-- 계정 비활성화 -->
    <update id="deactivateUser">
        UPDATE user
        SET user_status = 'DEACTIVATED',
            updated_at  = NOW()
        WHERE id = #{id}
          AND user_status = 'ACTIVATED'
          AND deleted_at IS NULL
    </update>

    <!-- 계정 활성화 -->
    <update id="reactivateUser">
        UPDATE user
        SET user_status = 'ACTIVATED',
            updated_at  = NOW()
        WHERE id = #{id}
          AND user_status = 'DEACTIVATED'
          AND deleted_at IS NULL
    </update>

    <!-- 계정 삭제 (Soft Delete) -->
    <update id="deleteUser">
        UPDATE user
        <set>
            email = CONCAT('deleted_', id, '_', UNIX_TIMESTAMP(), '@syncle.com'),
            password = 'UNKNOWN',
            nickname = '탈퇴한 사용자',
            description = NULL,
            position = NULL,
            profile_img = NULL,
            provider = 'LOCAL',
            provider_id = NULL,
            verify_status = 'EXPIRED',
            user_status = 'DELETED',
            updated_at = NOW(),
            deleted_at = NOW()
        </set>
        WHERE id = #{id}
        AND deleted_at IS NULL
    </update>

    <!-- 24시간 미인증 계정 삭제 (Hard Delete) -->
    <delete id="deleteUnverifiedUsers">
        DELETE
        FROM user
        WHERE verify_status = 'PENDING'
          AND created_at &lt; DATE_SUB(NOW(), INTERVAL 1 DAY)
    </delete>

    <!-- 30일 기간 만료된 비활성화 계정 아이디 목록 조회 -->
    <select id="findIdsByDeactivatedAndExpired">
        SELECT id
        FROM user
        WHERE user_status = 'DEACTIVATED'
          AND updated_at &lt; DATE_SUB(NOW(), INTERVAL 7 DAY)
          AND deleted_at IS NULL
    </select>

    <update id="updateProvider">
        UPDATE user
        SET provider    = #{provider},
            provider_id = #{providerId},
            updated_at  = NOW()
        WHERE id = #{id}
          AND deleted_at IS NULL
    </update>

</mapper>