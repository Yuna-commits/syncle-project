<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nullpointer.domain.user.mapper.UserMapper">

    <!-- 회원가입 -->
    <insert id="insertUser" parameterType="UserVo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user (email,
                          password,
                          nickname,
                          description,
                          position,
                          profile_img,
                          provider,
                          provider_id,
                          verify_status,
                          user_status,
                          created_at,
                          updated_at)
        VALUES (#{email},
                #{password},
                #{nickname},
                #{description},
                #{position},
                #{profileImg},
                #{provider},
                #{providerId},
                #{verifyStatus},
                #{userStatus},
                NOW(),
                NOW())
    </insert>

    <!-- 이메일 중복 확인 -->
    <select id="existsByEmail" parameterType="string" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM user
                      WHERE email = #{email}
                        AND deleted_at IS NULL)
    </select>

    <!-- 닉네임 중복 확인 -->
    <select id="existsByNickname" parameterType="string" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM user
                      WHERE nickname = #{nickname}
                        AND deleted_at IS NULL)
    </select>

    <!-- 사용자 조회 -->
    <select id="findById" parameterType="long" resultType="UserVo">
        SELECT *
        FROM user
        WHERE id = #{id}
          AND deleted_at IS NULL
    </select>

    <select id="findByEmail" parameterType="string" resultType="UserVo">
        SELECT *
        FROM user
        WHERE email = #{email}
          AND deleted_at IS NULL
    </select>

    <!-- 사용자 이메일 인증 상태 조건부 업데이트 -->
    <update id="updateVerifyStatusIfCurrent">
        UPDATE user
        SET verify_status = #{newStatus},
            updated_at    = NOW()
        WHERE id = #{id}
          AND verify_status = #{currentStatus}
          AND deleted_at IS NULL
    </update>

    <!-- 사용자 정보 조회 -->
    <select id="getUserProfile" resultType="com.nullpointer.domain.user.dto.response.UserProfileResponse">
        SELECT u.id,
               u.email,
               u.nickname,
               u.description,
               u.position,
               u.profile_img,
               u.verify_status,
               u.created_at,
               u.updated_at,
               (SELECT COUNT(*)
                FROM team_member tm
                WHERE tm.user_id = u.id
                  AND tm.deleted_at IS NULL) AS "activity.participatedTeams",
               (SELECT COUNT(*)
                FROM board_member bm
                WHERE bm.user_id = u.id
                  AND bm.deleted_at IS NULL) AS "activity.participatedBoards",
               (SELECT COUNT(*)
                FROM card_permission cp
                WHERE cp.user_id = u.id)     AS "activity.createdCards",
               (SELECT COUNT(*)
                FROM comment c
                         JOIN board_member bm ON c.board_member_id = bm.user_id
                WHERE bm.user_id = u.id
                  AND c.deleted_at IS NULL)  AS "activity.createdComments"
        -- 안 읽은 알림 개수 쿼리 추가 필요
        FROM user u
        WHERE u.id = #{id}
          AND u.deleted_at IS NULL
    </select>

    <!-- 사용자 정보 수정 -->
    <update id="updateUser">
        UPDATE user
        <set>
            <if test="nickname != null">nickname = #{nickname},</if>
            <if test="description != null">description = #{description},</if>
            <if test="position != null">position = #{position},</if>
            <if test="profileImg != null">profile_img = #{profileImg},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
        AND deleted_at IS NULL
    </update>

    <!-- 사용자 비밀번호 수정 -->
    <update id="updatePassword">
        UPDATE user
        SET password   = #{newPassword},
            updated_at = NOW()
        WHERE id = #{id}
          AND deleted_at IS NULL
    </update>

</mapper>